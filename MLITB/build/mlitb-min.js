var mlitb=mlitb||{REVISION:"ALPHA"};(function(a){a.W=[]})(mlitb);(function(b){var g=function(l){var k=[];if(typeof l[0].length==="undefined"&&typeof l.length==="number"){for(var n=0;n<l.length;n++){k[n]=l[n]}return k}else{if(typeof l[0].length==="number"){for(var n=0;n<l.length;n++){k[n]=[];for(var m=0;m<l[0].length;m++){k[n][m]=l[n][m]}}return k}}};var f=function(o,m){var l=[];for(var k=0;k<o;k++){l[k]=m()}return l};var c=function(k,s,p){var r=typeof s=="number"?p:s;var q={};if(typeof r==="undefined"||r==="zero"){q=function(){return 0}}else{if(r==="random"){q=function(){return Math.random()}}}if(typeof s==="number"){var o=[];for(var l=0;l<k;l++){o[l]=f(s,q)}return o}else{return f(k,q)}};var h=function(l,q){if(typeof l==="object"&&typeof q==="object"){var k=j(l);var p=j(q);if(k[0]===p[0]&&k[1]===p[1]){var o=[];for(var n=0;n<k[0];n++){o[n]=[];for(var m=0;m<k[1];m++){o[n][m]=l[n][m]+q[n][m]}}return o}else{console.log("ERROR!! matrix dimension does not match")}}else{if(typeof l==="object"&&typeof q==="number"){var k=j(l);var o=[];for(var n=0;n<k[0];n++){o[n]=[];for(var m=0;m<k[1];m++){o[n][m]=l[n][m]+q}}return o}}};var a=function(D,C,o){if(typeof D==="number"&&typeof C==="number"){return D*C}else{if(typeof D==="object"&&typeof C==="number"){var D=typeof D[0].length=="undefined"?[D]:D;var w=[];for(var u=0;u<D.length;u++){w[u]=[];for(var t=0;t<D[0].length;t++){w[u][t]=D[u][t]*C}}return w}else{var D=typeof D[0].length=="undefined"?[D]:D;var C=typeof C[0].length=="undefined"?[C]:C;var B=j(D);var A=j(C);if(typeof o==="undefined"&&B[1]!==A[0]){console.log("ERROR!! matrix dimension does not match")}else{if(o==="r"&&B[1]!==A[1]){console.log("ERROR!! matrix dimension does not match")}else{if(o==="l"&&B[0]!==A[0]){console.log("ERROR!! matrix dimension does not match")}else{var E=[];var n=o==="l"?B[1]:B[0];var m=o==="r"?A[0]:A[1];var l=o==="l"?B[0]:B[1];if(typeof o==="undefined"){var z=function(F,q,G,r,p){return F[G][p]*q[p][r]}}else{if(o==="r"){var z=function(F,q,G,r,p){return F[G][p]*q[r][p]}}else{if(o==="l"){var z=function(F,q,G,r,p){return F[p][G]*q[p][r]}}}}for(var u=0;u<n;u++){E[u]=[];for(var t=0;t<m;t++){var v=0;for(var s=0;s<l;s++){v+=z(D,C,u,t,s)}E[u][t]=v}}return E.length===1?E[0]:E}}}}}};var j=function(k){var k=typeof k[0].length=="undefined"?[k]:k;return[k.length,k[0].length]};var e=function(m,q,p){var l=Math.max.apply(null,m);var o=Math.min.apply(null,m);var k=[];for(var n=0;n<m.length;n++){k.push((m[n]-o)/(l-o)*(p-q)+q)}return k};var d=function(){};b.zeros=c;b.dot=a;b.add=h;b.normalize=e;b.clone=g})(mlitb);(function(b){var a={sigmoid:function(d){return 1/(1+Math.exp(-d))},sigmoid_bipolar:function(d){return -1+2/(1+Math.exp(-d))},linear:function(d){return d}};var c={sigmoid:function(d){return(1/(1+Math.exp(-d)))*(1-1/(1+Math.exp(-d)))},sigmoid_bipolar:function(d){return 0.5*(1+(-1+2/(1+Math.exp(-d))))*(1-(-1+2/(1+Math.exp(-d))))},linear:function(d){return 1}};b.fw_fn=a;b.bw_fn=c})(mlitb);(function(d){var c=function(e){this.n_neuron=e.n_neuron;this.outs=d.zeros(this.n_neuron)};c.prototype={forward:function(e){},backward:function(e){}};var a=function(e){this.n_neuron=e.n_neuron;this.act_fn=e.act_fn};a.prototype={forward:function(){this.outs=[];for(var e=0;e<this.n_neuron;e++){this.outs[e]=d.fw_fn[this.act_fn](this.ins[e])}this.outs.push(1)},backward:function(){this.delta=[];for(var e=0;e<this.n_neuron;e++){this.delta[e]=this.back_in[e]*d.bw_fn[this.act_fn](this.outs[e])}}};var b=function(e){this.n_neuron=e.n_neuron;this.act_fn=e.act_fn;this.outs=d.zeros(this.n_neuron)};b.prototype={forward:function(e){for(var f=0;f<this.n_neuron;f++){this.outs[f]=d.fw_fn[this.act_fn](this.ins[f])}},backward:function(f){this.delta=[];this.err=0;for(var e=0;e<this.n_neuron;e++){console.log("output "+this.outs[e]);console.log("error "+(f[e]-this.outs[e]));this.err=this.err+0.5*Math.pow((f[e]-this.outs[e]),2);this.delta[e]=(f[e]-this.outs[e])*d.bw_fn[this.act_fn](this.outs[e])}}};d.InputLayer=c;d.HiddenLayer=a;d.OutputLayer=b})(mlitb);(function(b){var a=function(){this.layers=[]};a.prototype={initWeight:function(c){for(var d=0;d<c.length-1;d++){b.W.push(b.zeros(c[d].n_neuron+1,c[d+1].n_neuron,"random"))}},createLayers:function(c){for(var d=0;d<c.length;d++){if(d==0){this.layers.push(new b.InputLayer(c[d]))}else{if(d==c.length-1){this.layers.push(new b.OutputLayer(c[d]))}else{this.layers.push(new b.HiddenLayer(c[d]))}}}},forward:function(e){var c=b.W;this.layers[0].outs=b.clone(e);this.layers[0].outs.push(1);for(var d=0;d<this.layers.length-1;d++){console.log("W ");console.log(c[d]);this.layers[d+1].ins=b.dot(this.layers[d].outs,c[d]);this.layers[d+1].forward();console.log("outs ");console.log(this.layers[d+1].outs)}},backward:function(e){var c=b.W;this.der=b.zeros(b.W.length);console.log("target "+e);for(var d=this.layers.length-1;d>0;d--){this.layers[d].backward(e);this.layers[d-1].back_in=b.dot(this.layers[d].delta,c[d-1],"r");this.der[d-1]=b.dot(this.layers[d-1].outs,this.layers[d].delta,"l")}}};b.Net=a})(mlitb);(function(b){var a=function(d,c){this.net=d;this.learning_rate=typeof c.learning_rate!=="undefined"?c.learning_rate:0.01;this.k=0;this.last_gs=[]};a.prototype={train:function(c,e){this.net.forward(c);this.net.backward(e);for(var d=0;d<this.net.der.length;d++){b.W[d]=mlitb.add(b.W[d],mlitb.dot(this.net.der[d],this.learning_rate))}},checkGrad:function(d,k){this.net.forward(d);var g=[];var c=[];for(var h=0;h<b.W.length;h++){g[h]=b.clone(b.W[h])}console.log("current W");console.log(g);this.net.backward(k);var f=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(f);for(var h=0;h<b.W.length;h++){c[h]=b.clone(this.net.der[h])}console.log("derivative");console.log(c);console.log("adding epsilon to current W");var j=0.0001;b.W[0][0][0]=b.W[0][0][0]+j;this.net.forward(d);this.net.backward(k);var e=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(e);console.log("manual grad");console.log((e-f)/j)}};mlitb.SGD=a})(mlitb);var x=[0,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95,1];x=mlitb.dot(x,Math.PI)[0];var label=(function(a){var c=[];for(var b in a){c.push(Math.sin(a[b]))}return c})(x);label=mlitb.normalize(label,0.1,0.9);x=[[0,0],[0,1],[1,0],[1,1]];y=[0,0,0,1];label=mlitb.normalize(y,0.1,0.9);console.log(x);console.log(label);var conf=[];conf.push({n_neuron:2});conf.push({n_neuron:20,act_fn:"sigmoid"});conf.push({n_neuron:1,act_fn:"linear"});var Net=new mlitb.Net();Net.initWeight(conf);Net.createLayers(conf);var SGD=new mlitb.SGD(Net,{learning_rate:0.25});for(var i=0;i<1000;i++){idx=parseInt((Math.random()*(x.length)),10);console.log("input "+x[idx]);SGD.train(x[idx],[label[idx]])}SGD.checkGrad(x[3],[y[3]]);