var mlitb=mlitb||{REVISION:"ALPHA"};(function(a){a.W=[]})(mlitb);(function(c){var n=function(r){var q=[];if(typeof r[0].length==="undefined"&&typeof r.length==="number"){for(var t=0;t<r.length;t++){q[t]=r[t]}return q}else{if(typeof r[0].length==="number"){for(var t=0;t<r.length;t++){q[t]=[];for(var s=0;s<r[0].length;s++){q[t][s]=r[t][s]}}return q}}};var m=function(t,s){var r=[];for(var q=0;q<t;q++){r[q]=s()}return r};var e=function(q,w,t){var v=typeof w=="number"?t:w;var u={};if(typeof v==="undefined"||v==="zero"){u=function(){return 0}}else{if(v==="random"){u=function(){return Math.random()}}}if(typeof w==="number"){var s=[];for(var r=0;r<q;r++){s[r]=m(w,u)}return s}else{return m(q,u)}};var o=function(r,w){if(typeof r==="object"&&typeof w==="object"){var q=p(r);var v=p(w);if(q[0]===v[0]&&q[1]===v[1]){var u=[];for(var t=0;t<q[0];t++){u[t]=[];for(var s=0;s<q[1];s++){u[t][s]=r[t][s]+w[t][s]}}return u}else{console.log("ERROR!! matrix dimension does not match")}}else{if(typeof r==="object"&&typeof w==="number"){var q=p(r);var u=[];for(var t=0;t<q[0];t++){u[t]=[];for(var s=0;s<q[1];s++){u[t][s]=r[t][s]+w}}return u}}};var a=function(H,G,v){if(typeof H==="number"&&typeof G==="number"){return H*G}else{if(typeof H==="object"&&typeof G==="number"){var H=typeof H[0].length=="undefined"?[H]:H;var C=[];for(var A=0;A<H.length;A++){C[A]=[];for(var z=0;z<H[0].length;z++){C[A][z]=H[A][z]*G}}return C}else{var H=typeof H[0].length=="undefined"?[H]:H;var G=typeof G[0].length=="undefined"?[G]:G;var F=p(H);var E=p(G);if(typeof v==="undefined"&&F[1]!==E[0]){console.log("ERROR!! matrix dimension does not match")}else{if(v==="r"&&F[1]!==E[1]){console.log("ERROR!! matrix dimension does not match")}else{if(v==="l"&&F[0]!==E[0]){console.log("ERROR!! matrix dimension does not match")}else{var I=[];var u=v==="l"?F[1]:F[0];var t=v==="r"?E[0]:E[1];var s=v==="l"?F[0]:F[1];if(typeof v==="undefined"){var D=function(K,r,L,J,q){return K[L][q]*r[q][J]}}else{if(v==="r"){var D=function(K,r,L,J,q){return K[L][q]*r[J][q]}}else{if(v==="l"){var D=function(K,r,L,J,q){return K[q][L]*r[q][J]}}}}for(var A=0;A<u;A++){I[A]=[];for(var z=0;z<t;z++){var B=0;for(var w=0;w<s;w++){B+=D(H,G,A,z,w)}I[A][z]=B}}return I.length===1?I[0]:I}}}}}};var p=function(q){var q=typeof q[0].length=="undefined"?[q]:q;return[q.length,q[0].length]};var h=function(s,w,v){var r=Math.max.apply(null,s);var u=Math.min.apply(null,s);var q=[];for(var t=0;t<s.length;t++){q.push((s[t]-u)/(r-u)*(v-w)+w)}return q};var f=function(){};var l=false;var d=0;var k=function(){if(l){l=false;return d}var s=2*Math.random()-1;var q=2*Math.random()-1;var t=s*s+q*q;if(t==0||t>1){return k()}var w=Math.sqrt(-2*Math.log(t)/t);d=q*w;l=true;return s*w};var j=function(r,q){return Math.random()*(q-r)+r};var g=function(r,q){return Math.floor(Math.random()*(q-r)+r)};var b=function(r,q){return r+k()*q};c.zeros=e;c.dot=a;c.add=o;c.normalize=h;c.clone=n;c.randf=j;c.randi=g;c.randn=b})(mlitb);(function(b){var a=function(k,g,f,j){this.sx=k;this.sy=g;this.depth=f;var h=k*g*f;this.data=b.zeros(h);this.drv=b.zeros(h);if(typeof j==="number"){for(var d=0;d<h;d++){this.data[d]=j}}else{var e=Math.sqrt(1/(k*g*f));for(var d=0;d<h;d++){this.data[d]=b.randn(0,e)}}};a.prototype={get:function(e,h,g,f){var c=((this.sx*h)+e)+this.sx*this.sy*g;if(typeof f==="undefined"||f==="data"){return this.data[c]}else{if(f==="drv"){return this.drv[c]}}},set:function(e,j,h,f,g){var c=((this.sx*j)+e)+this.sx*this.sy*h;if(typeof g==="undefined"||g==="data"){this.data[c]=f}else{if(g==="drv"){this.drv[c]=f}}},cloneAndZeros:function(){return new a(this.sx,this.sy,this.depth,0)},clone:function(){var c=new a(this.sx,this.sy,this.depth,0);for(var d=0;d<this.data.length;d++){c.data[d]=this.data[d]}return c},getIndex:function(c,f,e){return((this.sx*f)+c)+this.sx*this.sy*e}};b.Vol=a})(mlitb);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.out_sx=d.sx;this.out_sy=d.sy;this.out_depth=d.depth;this.layer_type="input"};b.prototype={forward:function(d,e){this.V_in=d;this.V_out=d;return this.V_out},backward:function(){},getParamsAndGrads:function(){return[]}};c.InputLayer=b})(mlitb);(function(b){var a=b.Vol;var c=function(d){this.sx=d.sx;this.in_sx=d.in_sx;this.in_sy=d.in_sy;this.in_depth=d.in_depth;this.out_depth=d.filters;this.sy=typeof d.sy!=="undefined"?d.sy:d.sx;this.stride=(typeof d.stride!=="undefined"&&d.stride<=Math.min(this.sx,this.sy))?d.stride:1;this.out_sx=Math.ceil(d.in_sx/this.stride);this.out_sy=Math.ceil(d.in_sy/this.stride);this.filters=[];for(var e=0;e<d.filters;e++){this.filters.push(new a(this.sx,this.sy,this.in_depth,1))}this.biases=new b.Vol(1,1,this.out_depth,1);this.conv_type=typeof d.conv_type!=="undefined"?d.conv_type:"same";this.layer_type="conv"};c.prototype={forward:function(l,n){this.V_in=l;var C=Math.floor(this.sx/2);var z=Math.floor(this.sy/2);var u=this.out_sx*this.out_sy;var r=new b.Vol(this.out_sx,this.out_sy,this.out_depth,0);var D=r.data;for(var w=0,p=0;w<r.depth;w++){var E=this.biases.data[w];for(var v=0;v<r.sx*r.sy;v++,p++){D[p]=E}}for(var t=0;t<r.depth;t++){var B=this.filters[t];for(var s=0,q=t*u;s<B.depth;s++,q=t*u){for(var d=0;d<l.sy;d+=this.stride){for(var g=0;g<l.sx;g+=this.stride,q++){var F=0;var o=s*B.sx*B.sy;for(var e=d;e<B.sy+d;e++){for(var k=g;k<B.sx+g;k++,o++){var h=e-z;var m=k-C;if(m>=0&&h>=0&&m<l.sx&&h<l.sy){F+=B.data[o]*l.data[((l.sx*h)+m)+l.sx*l.sy*s]}}}D[q]+=F}}}}this.V_out=r;return this.V_out},backward:function(){var t=this.V_in;var z=Math.floor(this.sx/2);var v=Math.floor(this.sy/2);var r=this.out_sx*this.out_sy;var A=this.V_out;for(var u=0,n=0;u<A.depth;u++){for(var s=0;s<A.sx*A.sy;s++,n++){this.biases.data[u]+=A.data[n]}}for(var q=0;q<A.depth;q++){var w=this.filters[q];for(var p=0,o=q*r;p<w.depth;p++,o=q*r){for(var d=0;d<t.sy;d+=this.stride){for(var e=0;e<t.sx;e+=this.stride,o++){var m=p*w.sx*w.sy;for(var g=d;g<w.sy+d;g++){for(var k=e;k<w.sx+e;k++,m++){var h=g-v;var l=k-z;if(l>=0&&h>=0&&l<t.sx&&h<t.sy){t.drv[((t.sx*h)+l)+t.sx*t.sy*p]+=w.data[m]*A.drv[o];w.drv[m]+=t.data[((V.sx*h)+l)+V.sx*V.sy*p]*A.drv[o]}}}}}}}},getParamsAndGrads:function(){var d=[];for(var e=0;e<this.filters.length;e++){d.push({params:this.filters[e].data,grads:this.filters[e].drv})}d.push({params:this.biases.data,grads:this.biases.drv});return d}};b.ConvLayer=c})(mlitb);(function(b){var a=b.Vol;var c=function(d){this.in_neurons=d.in_neurons;this.out_depth=d.num_neurons;this.out_sx=1;this.out_sy=1;this.weights=new b.Vol(1,this.in_neurons,this.out_depth);this.biases=new b.Vol(1,1,this.out_depth,0.1);this.layer_type="fc"};c.prototype={forward:function(f,t){this.V_in=f;var q=f.data;var k=new b.Vol(1,1,this.out_depth);var l=k.data;var r=this.weights.data;var o=this.biases;var s=0;for(var h=0,e=this.out_depth;h<e;h++){var p=0;for(var g=0,d=this.in_neurons;g<d;g++,s++){p+=q[g]*r[s]}p+=o.data[h];l[h]=p}this.V_out=k;return this.V_out},backward:function(){var q=this.V_in.drv;var l=this.weights.data;var d=this.weights.drv;var r=this.biases.drv;var k=this.V_in.data;var o=0;for(var h=0,f=this.out_depth;h<f;h++){var p=this.V_out.drv[h];for(var g=0,e=this.in_neurons;g<e;g++,o++){q[g]+=p*l[o];d[o]+=p*k[g]}r[h]+=p}},getParamsAndGrads:function(){var d=[];d.push({params:this.weights.data,grads:this.weights.drv});d.push({params:this.biases.data,grads:this.biases.drv});return d}};b.FullConnLayer=c})(mlitb);(function(f){var a=f.Vol;var c={sigmoid:function(j){return 1/(1+Math.exp(-j))},sigmoid_bipolar:function(j){return -1+2/(1+Math.exp(-j))},linear:function(j){return j}};var h={sigmoid:function(j){return(1/(1+Math.exp(-j)))*(1-1/(1+Math.exp(-j)))},sigmoid_bipolar:function(j){return 0.5*(1+(-1+2/(1+Math.exp(-j))))*(1-(-1+2/(1+Math.exp(-j))))},linear:function(j){return 1}};var g=function(j){this.out_sx=j.in_sx;this.out_sy=j.in_sy;this.out_depth=j.in_depth;this.layer_type="sigmoid"};g.prototype={forward:function(j,m){this.V_in=j;var l=j.cloneAndZeros();var n=j.data.length;for(var k=0;k<n;k++){l.data[k]=1/(1+Math.exp(-j.data[k]))}this.V_out=l;return this.V_out},backward:function(j){var o=this.V_out.data;var p=f.zeros(m);var m=this.V_in.data.length;if(typeof j==="undefined"){var k=this.V_out.drv;for(var l=0;l<m;l++){var n=o[l];p[l]=n*(1-n)*k[l]}this.V_in.drv=p}else{j=typeof j==="number"?[j]:j;var r=0;for(var l=0;l<m;l++){var n=o[l];var q=n-j[l];p[l]=n*(1-n)*q;r+=(q*q)/2}this.V_in.drv=p;return r}},getParamsAndGrads:function(){return[]}};var d=function(j){this.out_sx=j.in_sx;this.out_sy=j.in_sy;this.out_depth=j.in_depth;this.layer_type="relu"};d.prototype={forward:function(k,o){this.V_in=k;var n=k.clone();var m=n.data;var j=k.data;var p=k.data.length;for(var l=0;l<p;l++){if(j[l]<=0){m[l]=0}}this.V_out=n;return this.V_out},backward:function(o){var m=this.V_out.drv;var k=this.V_out.data;var n=this.V_in.data.length;var l=f.zeros(n);for(var j=0;j<n;j++){if(k[j]<=0){l[j]=0}else{l[j]=m[j]}}this.V_in.drv=l},getParamsAndGrads:function(){return[]}};var e=function(j){var j=j||{};this.num_inputs=j.in_sx*j.in_sy*j.in_depth;this.out_depth=this.num_inputs;this.out_sx=1;this.out_sy=1;this.layer_type="softmax"};e.prototype={forward:function(k,q){this.V_in=k;var p=new a(1,1,this.out_depth,0);var j=k.data;var o=k.data[0];for(var l=1;l<this.out_depth;l++){if(j[l]>o){o=j[l]}}var m=f.zeros(this.out_depth);var n=0;for(var l=0;l<this.out_depth;l++){m[l]=Math.exp(j[l]-o);n+=m[l]}for(var l=0;l<this.out_depth;l++){m[l]/=n}p.data=m;this.Z_data=m;this.V_out=p;return this.V_out},backward:function(l){V_in_drv=f.zeros(this.V_in.data.length);for(var k=0;k<this.out_depth;k++){var j=k===l?1:0;V_in_drv[k]=-(j-this.Z_data[k])}this.V_in.drv=V_in_drv;return -Math.log(this.V_out.data[l])},getParamsAndGrads:function(){return[]}};var b=function(j){this.out_sx=j.in_sx;this.out_sy=j.in_sy;this.out_depth=j.in_depth;this.layer_type="linear"};b.prototype={forward:function(j,l){this.V_in=j;var k=j.clone();this.V_out=k;return this.V_out},backward:function(p){var k=this.V_out.data;var n=f.zeros(o);var o=this.V_in.data.length;if(typeof p==="undefined"){var m=this.V_out.drv;for(var j=0;j<o;j++){n[j]=m[j]}this.V_in.drv=n}else{var p=typeof p==="number"?[p]:p;var l=0;for(var j=0;j<o;j++){var m=k[j]-p[j];n[j]=m;l+=(m*m)/2}this.V_in.drv=n;return l}},getParamsAndGrads:function(){return[]}};f.LinearLayer=b;f.SoftmaxLayer=e;f.ReLuLayer=d;f.SigmoidLayer=g;f.fw_fn=c;f.bw_fn=h})(mlitb);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.sx=d.sx;this.in_depth=d.in_depth;this.in_sx=d.in_sx;this.in_sy=d.in_sy;this.sy=typeof d.sy!=="undefined"?d.sy:this.sx;this.stride=(typeof d.stride!=="undefined"&&d.stride<=this.sx)?d.stride:this.sx;this.ignore_border=typeof d.ignore_border!=="undefined"?d.ignore_border:false;this.pool_type=typeof d.pool_type!=="undefined"?d.pool_type:"max";this.out_depth=this.in_depth;this.out_sx=Math.floor(this.in_sx/this.stride);this.out_sy=Math.floor(this.in_sy/this.stride);this.max_pos_x=c.zeros(this.out_sx*this.out_sy*this.out_depth);this.max_pos_y=c.zeros(this.out_sx*this.out_sy*this.out_depth);this.layer_type="pool"};b.prototype={forward:function(h,l){this.V_in=h;var e=new a(this.out_sx,this.out_sy,this.out_depth,0);var t=this.max_pos_x;var s=this.max_pos_y;var o=e.data;var z=Math.floor(this.sx/2);var u=Math.floor(this.sy/2);var r=0;for(var A=0;A<this.out_depth;A++){for(var p=0,j=0;j<this.out_sy;p+=this.stride,j++){for(var q=0,k=0;k<this.out_sx;q+=this.stride,k++,r++){var C=-99999999;var B=-1;var w=-1;for(var f=p;f<this.sy+p;f++){for(var g=q;g<this.sx+q;g++){var m=-999999999;if(g<this.in_sx&&f<this.in_sy){m=h.get(g,f,A)}if(m>C){C=m;B=g;w=f}}}e.data[r]=C;t[r]=B;s[r]=w}}}this.V_out=e;return this.V_out},backward:function(){var p=this.V_in;p.drv=c.zeros(p.data.length);var m=p.drv;var h=this.V_out.drv;var o=this.max_pos_x;var l=this.max_pos_y;var e=0;for(var j=0;j<this.out_depth;j++){for(var f=0;f<this.out_sy;f++){for(var g=0;g<this.out_sx;g++,e++){var k=p.getIndex(o[e],l[e],j);m[k]+=h[e]}}}},getParamsAndGrads:function(){return[]}},c.PoolLayer=b})(mlitb);(function(b){var a=function(){this.layers=[];this.layer_conf=[]};a.prototype={createLayers:function(d){if(d[0].type!=="input"){console.log("ERROR : First layer should be an input type layer")}var f=[];for(var e=0;e<d.length;e++){var h=d[e];f.push(h);if(h.type==="conv"){if(typeof h.activation!=="undefined"){f.push({type:h.activation})}else{f.push({type:"relu"})}}else{if(h.type==="fc"){if(typeof h.num_neurons==="undefined"){console.log("ERROR : number of neuron parameter 'num_neurons' is not defined")}if(typeof h.activation!=="undefined"){f.push({type:h.activation})}else{f.push({type:"linear"})}}else{if(h.type==="pool"){if(typeof h.sx==="undefined"){console.log("ERROR : pool size parameter 'sx' is not defined")}if(typeof h.stride==="number"){var g=typeof h.sy==="number"?Math.min(h.sx,h.sy):h.sx;if(h.stride>g){console.log("BAD PARAMETER : stride should <= pooling size")}}else{console.log("WARNING : 'stride' parameter is not defined. Using default = 1")}}}}}this.layer_conf=f;this.constructNetwork()},constructNetwork:function(){var f=this.layer_conf;this.layers.push(new b.InputLayer(f[0]));for(var d=1;d<f.length;d++){var e=this.layers[d-1];var c=f[d];c.in_sx=e.out_sx;c.in_sy=e.out_sy;c.in_depth=e.out_depth;c.in_neurons=e.out_sx*e.out_sy*e.out_depth;if(c.type==="fc"){this.layers.push(new b.FullConnLayer(c))}else{if(c.type==="conv"){this.layers.push(new b.ConvLayer(c))}else{if(c.type==="sigmoid"){this.layers.push(new b.SigmoidLayer(c))}else{if(c.type==="softmax"){this.layers.push(new b.SoftmaxLayer(c))}else{if(c.type==="linear"){this.layers.push(new b.LinearLayer(c))}else{if(c.type==="relu"){this.layers.push(new b.ReLuLayer(c))}else{if(c.type==="pool"){this.layers.push(new b.PoolLayer(c))}}}}}}}}},forward:function(f){var d=f;for(var e=0;e<this.layers.length;e++){var c=this.layers[e].forward(d);d=c}console.log("predict  : "+d.data)},backward:function(e){var d=this.layers[this.layers.length-1].backward(e);for(var c=this.layers.length-2;c>=0;c--){this.layers[c].backward()}return d},saveNetwork:function(){var c={};c.layer_conf=this.layer_conf;return c},loadNetwork:function(c){this.layer_conf=c.layer_conf;this.constructNetwork()},getParamsAndGrads:function(){var d=[];for(var e=0;e<this.layers.length;e++){var f=this.layers[e].getParamsAndGrads();for(var c=0;c<f.length;c++){d.push(f[c])}}return d}};b.Net=a})(mlitb);(function(b){var a=function(d,c){this.net=d;this.learning_rate=typeof c.learning_rate!=="undefined"?c.learning_rate:0.01;this.k=0;this.last_gs=[]};a.prototype={train:function(c,e){this.net.forward(c);this.net.backward(e);for(var d=0;d<this.net.der.length;d++){b.W[d]=mlitb.add(b.W[d],mlitb.dot(this.net.der[d],this.learning_rate))}},checkGrad:function(d,k){this.net.forward(d);var g=[];var c=[];for(var h=0;h<b.W.length;h++){g[h]=b.clone(b.W[h])}console.log("current W");console.log(g);this.net.backward(k);var f=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(f);for(var h=0;h<b.W.length;h++){c[h]=b.clone(this.net.der[h])}console.log("derivative");console.log(c);console.log("adding epsilon to current W");var j=0.0001;b.W[0][0][0]=b.W[0][0][0]+j;this.net.forward(d);this.net.backward(k);var e=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(e);console.log("manual grad");console.log((e-f)/j)}};mlitb.SGD=a})(mlitb);(function(b){var a=function(d,c){this.net=d;console.log(c);this.learning_rate=typeof c.learning_rate!=="undefined"?c.learning_rate:0.01;this.l1_decay=typeof c.l1_decay!=="undefined"?c.l1_decay:0;this.l2_decay=typeof c.l2_decay!=="undefined"?c.l2_decay:0;this.batch_size=typeof c.batch_size!=="undefined"?c.batch_size:1;this.momentum=typeof c.momentum!=="undefined"?c.momentum:0.9;this.iteration=0;this.last_grads=[]};a.prototype={train:function(h,e){this.net.forward(h,true);var s=this.net.backward(e);console.log("loss : "+s);this.iteration++;if(this.iteration%this.batch_size==0){var o=this.net.getParamsAndGrads();if(this.last_grads.length==0&&this.momentum>0){for(var m=0;m<o.length;m++){this.last_grads.push(b.zeros(o[m].grads.length))}}for(var m=0;m<o.length;m++){var q=o[m];var f=q.params;var n=q.grads;var k=f.length;var r=this.last_grads[m];for(var l=0;l<k;l++){var d=r[l];var c=(1-this.momentum)*this.learning_rate*(n[l]/this.batch_size)+this.momentum*d;f[l]-=c;d=c}}}}};b.SGDTrainer=a})(mlitb);var x=[0,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95,1];x=mlitb.dot(x,Math.PI)[0];var label=(function(a){var c=[];for(var b in a){c.push(Math.sin(a[b]))}return c})(x);label=mlitb.normalize(label,0.1,0.9);x=[[0,0],[0,1],[1,0],[1,1]];y=[0,0,0,1];label=mlitb.normalize(y,0.1,0.9);var V=new mlitb.Vol(1,1,2,1);var FC=new mlitb.FullConnLayer({in_neurons:2,num_neurons:3});var FCfw=FC.forward(V);var SIG=new mlitb.SigmoidLayer({out_sx:1,out_sy:1,out_depth:3});var SIGfw=SIG.forward(FCfw);SIG.V_out.data=[0.5,0.5,0.5];var target=[1,1,1];var SIGbw=SIG.backward(target);var FCbw=FC.backward();var inputpool=[1,1,2,2,3,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,1,1,1,1,1];var Vpool=new mlitb.Vol(5,5,2);Vpool.data=inputpool;var conv=new mlitb.ConvLayer({stride:2,sx:3,in_sx:5,in_sy:5,in_depth:2,filters:2});var start=new Date().getTime();x=[[0,0],[0,1],[1,0],[1,1]];y=[0,0,0,1];var conf=[];conf.push({type:"input",sx:1,sy:1,depth:2});conf.push({type:"fc",num_neurons:5,activation:"relu"});conf.push({type:"fc",num_neurons:1,activation:"linear"});var Net=new mlitb.Net();Net.createLayers(conf);var SGD=new mlitb.SGDTrainer(Net,{});for(var i=0;i<1000;i++){var idx=Math.floor(Math.random()*4)+0;var xi=x[idx];var yi=y[idx];var Input=new mlitb.Vol(1,1,2);console.log("xi : ");console.log(xi);console.log("y");console.log(yi);Input.data=xi;SGD.train(Input,yi)};