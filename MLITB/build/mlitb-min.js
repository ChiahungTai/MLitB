var mlitb=mlitb||{REVISION:"ALPHA"};(function(a){a.W=[]})(mlitb);(function(c){var l=function(p){var o=[];if(typeof p[0].length==="undefined"&&typeof p.length==="number"){for(var r=0;r<p.length;r++){o[r]=p[r]}return o}else{if(typeof p[0].length==="number"){for(var r=0;r<p.length;r++){o[r]=[];for(var q=0;q<p[0].length;q++){o[r][q]=p[r][q]}}return o}}};var e=function(q){if(typeof(q)==="undefined"||isNaN(q)){return[]}if(typeof ArrayBuffer==="undefined"){var o=new Array(q);for(var p=0;p<q;p++){o[p]=0}return o}else{return new Float64Array(q)}};var m=function(p,u){if(typeof p==="object"&&typeof u==="object"){var o=n(p);var t=n(u);if(o[0]===t[0]&&o[1]===t[1]){var s=[];for(var r=0;r<o[0];r++){s[r]=[];for(var q=0;q<o[1];q++){s[r][q]=p[r][q]+u[r][q]}}return s}else{console.log("ERROR!! matrix dimension does not match")}}else{if(typeof p==="object"&&typeof u==="number"){var o=n(p);var s=[];for(var r=0;r<o[0];r++){s[r]=[];for(var q=0;q<o[1];q++){s[r][q]=p[r][q]+u}}return s}}};var a=function(E,D,u){if(typeof E==="number"&&typeof D==="number"){return E*D}else{if(typeof E==="object"&&typeof D==="number"){var E=typeof E[0].length=="undefined"?[E]:E;var z=[];for(var x=0;x<E.length;x++){z[x]=[];for(var w=0;w<E[0].length;w++){z[x][w]=E[x][w]*D}}return z}else{var E=typeof E[0].length=="undefined"?[E]:E;var D=typeof D[0].length=="undefined"?[D]:D;var C=n(E);var B=n(D);if(typeof u==="undefined"&&C[1]!==B[0]){console.log("ERROR!! matrix dimension does not match")}else{if(u==="r"&&C[1]!==B[1]){console.log("ERROR!! matrix dimension does not match")}else{if(u==="l"&&C[0]!==B[0]){console.log("ERROR!! matrix dimension does not match")}else{var F=[];var t=u==="l"?C[1]:C[0];var s=u==="r"?B[0]:B[1];var o=u==="l"?C[0]:C[1];if(typeof u==="undefined"){var A=function(G,q,H,r,p){return G[H][p]*q[p][r]}}else{if(u==="r"){var A=function(G,q,H,r,p){return G[H][p]*q[r][p]}}else{if(u==="l"){var A=function(G,q,H,r,p){return G[p][H]*q[p][r]}}}}for(var x=0;x<t;x++){F[x]=[];for(var w=0;w<s;w++){var y=0;for(var v=0;v<o;v++){y+=A(E,D,x,w,v)}F[x][w]=y}}return F.length===1?F[0]:F}}}}}};var n=function(o){var o=typeof o[0].length=="undefined"?[o]:o;return[o.length,o[0].length]};var h=function(q,u,t){var p=Math.max.apply(null,q);var s=Math.min.apply(null,q);var o=[];for(var r=0;r<q.length;r++){o.push((q[r]-s)/(p-s)*(t-u)+u)}return o};var f=function(){};var k=false;var d=0;var j=function(){if(k){k=false;return d}var p=2*Math.random()-1;var o=2*Math.random()-1;var q=p*p+o*o;if(q==0||q>1){return j()}var s=Math.sqrt(-2*Math.log(q)/q);d=o*s;k=true;return p*s};var i=function(p,o){return Math.random()*(o-p)+p};var g=function(p,o){return Math.floor(Math.random()*(o-p)+p)};var b=function(p,o){return p+j()*o};c.zeros=e;c.dot=a;c.add=m;c.normalize=h;c.clone=l;c.randf=i;c.randi=g;c.randn=b})(mlitb);(function(b){var a=function(l,h,g,k){this.sx=l;this.sy=h;this.depth=g;var j=l*h*g;this.data=b.zeros(j);this.drv=b.zeros(j);if(typeof k==="number"||typeof k==="boolean"){for(var e=0;e<j;e++){this.data[e]=k}}else{if(typeof k==="object"){var d=k.prob;for(var e=0;e<j;e++){this.data[e]=(Math.random()<d?0:1)}}else{var f=Math.sqrt(1/(l*h*g));for(var e=0;e<j;e++){this.data[e]=b.randn(0,f)}}}};a.prototype={get:function(e,h,g,f){var c=((this.sx*h)+e)+this.sx*this.sy*g;if(typeof f==="undefined"||f==="data"){return this.data[c]}else{if(f==="drv"){return this.drv[c]}}},set:function(e,i,h,f,g){var c=((this.sx*i)+e)+this.sx*this.sy*h;if(typeof g==="undefined"||g==="data"){this.data[c]=f}else{if(g==="drv"){this.drv[c]=f}}},cloneAndZeros:function(){return new a(this.sx,this.sy,this.depth,0)},clone:function(){var c=new a(this.sx,this.sy,this.depth,0);for(var d=0;d<this.data.length;d++){c.data[d]=this.data[d]}return c},getIndex:function(c,f,e){return((this.sx*f)+c)+this.sx*this.sy*e}};b.Vol=a})(mlitb);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.out_sx=d.sx;this.out_sy=d.sy;this.out_depth=d.depth;this.layer_type="input"};b.prototype={forward:function(d,e){this.V_in=d;this.V_out=d;return this.V_out},backward:function(){},getParamsAndGrads:function(){return[]}};c.InputLayer=b})(mlitb);(function(b){var a=b.Vol;var c=function(d){this.sx=d.sx;this.in_sx=d.in_sx;this.in_sy=d.in_sy;this.in_depth=d.in_depth;this.out_depth=d.filters;this.sy=typeof d.sy!=="undefined"?d.sy:d.sx;this.stride=(typeof d.stride!=="undefined"&&d.stride<=Math.min(this.sx,this.sy))?d.stride:1;this.drop_conn_prob=typeof d.drop_conn_prob==="number"?d.drop_conn_prob:0;this.out_sx=Math.ceil(d.in_sx/this.stride);this.out_sy=Math.ceil(d.in_sy/this.stride);this.filters=[];for(var e=0;e<d.filters;e++){this.filters.push(new a(this.sx,this.sy,this.in_depth))}this.biases=new b.Vol(1,1,this.out_depth,0.1);this.conv_type=typeof d.conv_type!=="undefined"?d.conv_type:"same";this.layer_type="conv"};c.prototype={forward:function(l,o){this.V_in=l;this.Mask=[];if(o){for(var y=0;y<conf.filters;y++){this.Mask.push(new a(this.sx,this.sy,this.in_depth,{type:"bern",prob:this.drop_conn_prob}))}}else{for(var y=0;y<conf.filters;y++){this.Mask.push(new a(this.sx,this.sy,this.in_depth,{type:"bern",prob:0}))}}var C=Math.floor(this.sx/2);var z=Math.floor(this.sy/2);var w=this.out_sx*this.out_sy;var s=new b.Vol(this.out_sx,this.out_sy,this.out_depth,0);var D=s.data;for(var y=0,q=0;y<s.depth;y++){var E=this.biases.data[y];for(var x=0;x<s.sx*s.sy;x++,q++){D[q]=E}}for(var u=0;u<s.depth;u++){var B=this.filters[u];var v=this.Mask[u];for(var t=0,r=u*w;t<B.depth;t++,r=u*w){for(var d=0;d<l.sy;d+=this.stride){for(var g=0;g<l.sx;g+=this.stride,r++){var F=0;var p=t*B.sx*B.sy;for(var e=d;e<B.sy+d;e++){for(var k=g;k<B.sx+g;k++,p++){var h=e-z;var n=k-C;if(n>=0&&h>=0&&n<l.sx&&h<l.sy){F+=v.data[p]*B.data[p]*l.data[((l.sx*h)+n)+l.sx*l.sy*t]}}}D[r]+=F}}}}this.V_out=s;return this.V_out},backward:function(){var v=this.V_in;var z=Math.floor(this.sx/2);var x=Math.floor(this.sy/2);var t=this.out_sx*this.out_sy;var A=this.V_out;for(var w=0,o=0;w<A.depth;w++){for(var u=0;u<A.sx*A.sy;u++,o++){this.biases.drv[w]+=A.drv[o]}}for(var r=0;r<A.depth;r++){var y=this.filters[r];var s=this.Mask[r];for(var q=0,p=r*t;q<y.depth;q++,p=r*t){for(var d=0;d<v.sy;d+=this.stride){for(var e=0;e<v.sx;e+=this.stride,p++){var n=q*y.sx*y.sy;for(var g=d;g<y.sy+d;g++){for(var k=e;k<y.sx+e;k++,n++){var h=g-x;var l=k-z;if(l>=0&&h>=0&&l<v.sx&&h<v.sy){v.drv[((v.sx*h)+l)+v.sx*v.sy*q]+=y.data[n]*A.drv[p];y.drv[n]+=s.data[n]*v.data[((v.sx*h)+l)+v.sx*v.sy*q]*A.drv[p]}}}}}}}},getParamsAndGrads:function(){var d=[];for(var e=0;e<this.filters.length;e++){d.push({params:this.filters[e].data,grads:this.filters[e].drv})}d.push({params:this.biases.data,grads:this.biases.drv});return d}};b.ConvLayer=c})(mlitb);(function(b){var a=b.Vol;var c=function(d){this.in_neurons=d.in_neurons;this.out_depth=d.num_neurons;this.out_sx=1;this.out_sy=1;this.weights=new a(1,this.in_neurons,this.out_depth);this.biases=new a(1,1,this.out_depth,0.1);this.drop_conn_prob=typeof d.drop_conn_prob==="number"?d.drop_conn_prob:0;this.layer_type="fc"};c.prototype={forward:function(f,u){this.V_in=f;if(u){this.Mask=new a(1,this.in_neurons,this.out_depth,{type:"bern",prob:this.drop_conn_prob})}else{this.Mask=new a(1,this.in_neurons,this.out_depth,{type:"bern",prob:0})}var p=this.Mask.data;var r=f.data;var k=new a(1,1,this.out_depth);var l=k.data;var t=this.weights.data;var o=this.biases;var s=0;for(var h=0,e=this.out_depth;h<e;h++){var q=0;for(var g=0,d=this.in_neurons;g<d;g++,s++){q+=r[g]*t[s]*p[s]}q+=o.data[h];l[h]=q}this.V_out=k;return this.V_out},backward:function(){var r=this.V_in.drv;var o=this.weights.data;var d=this.weights.drv;var s=this.biases.drv;var l=this.V_in.data;var k=this.Mask.data;var p=0;for(var h=0,f=this.out_depth;h<f;h++){var q=this.V_out.drv[h];for(var g=0,e=this.in_neurons;g<e;g++,p++){r[g]+=q*o[p];d[p]+=q*l[g]*k[p]}s[h]+=q}},getParamsAndGrads:function(){var d=[];d.push({params:this.weights.data,grads:this.weights.drv});d.push({params:this.biases.data,grads:this.biases.drv});return d}};b.FullConnLayer=c})(mlitb);(function(f){var a=f.Vol;var c={sigmoid:function(i){return 1/(1+Math.exp(-i))},sigmoid_bipolar:function(i){return -1+2/(1+Math.exp(-i))},linear:function(i){return i}};var h={sigmoid:function(i){return(1/(1+Math.exp(-i)))*(1-1/(1+Math.exp(-i)))},sigmoid_bipolar:function(i){return 0.5*(1+(-1+2/(1+Math.exp(-i))))*(1-(-1+2/(1+Math.exp(-i))))},linear:function(i){return 1}};var g=function(i){this.out_sx=i.in_sx;this.out_sy=i.in_sy;this.out_depth=i.in_depth;this.layer_type="sigmoid"};g.prototype={forward:function(j,m){this.V_in=j;var l=j.cloneAndZeros();var n=j.data.length;for(var k=0;k<n;k++){l.data[k]=1/(1+Math.exp(-j.data[k]))}this.V_out=l;return this.V_out},backward:function(j){var o=this.V_out.data;var p=f.zeros(m);var m=this.V_in.data.length;if(typeof j==="undefined"){var k=this.V_out.drv;for(var l=0;l<m;l++){var n=o[l];p[l]=n*(1-n)*k[l]}this.V_in.drv=p}else{j=typeof j==="number"?[j]:j;var r=0;for(var l=0;l<m;l++){var n=o[l];var q=n-j[l];p[l]=n*(1-n)*q;r+=(q*q)/2}this.V_in.drv=p;return r}},getParamsAndGrads:function(){return[]}};var d=function(i){this.out_sx=i.in_sx;this.out_sy=i.in_sy;this.out_depth=i.in_depth;this.layer_type="relu"};d.prototype={forward:function(k,o){this.V_in=k;var n=k.clone();var m=n.data;var j=k.data;var p=k.data.length;for(var l=0;l<p;l++){if(j[l]<=0){m[l]=0}}this.V_out=n;return this.V_out},backward:function(o){var m=this.V_out.drv;var k=this.V_out.data;var n=this.V_in.data.length;var l=f.zeros(n);for(var j=0;j<n;j++){if(k[j]<=0){l[j]=0}else{l[j]=m[j]}}this.V_in.drv=l},getParamsAndGrads:function(){return[]}};var e=function(i){var i=i||{};this.num_inputs=i.in_sx*i.in_sy*i.in_depth;this.out_depth=this.num_inputs;this.out_sx=1;this.out_sy=1;this.layer_type="softmax"};e.prototype={forward:function(k,q){this.V_in=k;var p=new a(1,1,this.out_depth,0);var j=k.data;var o=k.data[0];for(var l=1;l<this.out_depth;l++){if(j[l]>o){o=j[l]}}var m=f.zeros(this.out_depth);var n=0;for(var l=0;l<this.out_depth;l++){m[l]=Math.exp(j[l]-o);n+=m[l]}for(var l=0;l<this.out_depth;l++){m[l]/=n}p.data=m;this.Z_data=m;this.V_out=p;return this.V_out},backward:function(m){var l=f.zeros(this.V_in.data.length);for(var k=0;k<this.out_depth;k++){var j=k===m?1:0;l[k]=this.Z_data[k]-j}this.V_in.drv=l;return -Math.log(this.V_out.data[m])},getParamsAndGrads:function(){return[]}};var b=function(i){this.out_sx=i.in_sx;this.out_sy=i.in_sy;this.out_depth=i.in_depth;this.layer_type="linear"};b.prototype={forward:function(i,k){this.V_in=i;var j=i.clone();this.V_out=j;return this.V_out},backward:function(p){var k=this.V_out.data;var n=f.zeros(o);var o=this.V_in.data.length;if(typeof p==="undefined"){var m=this.V_out.drv;for(var j=0;j<o;j++){n[j]=m[j]}this.V_in.drv=n}else{var p=typeof p==="number"?[p]:p;var l=0;for(var j=0;j<o;j++){var m=k[j]-p[j];n[j]=m;l+=(m*m)/2}this.V_in.drv=n;return l}},getParamsAndGrads:function(){return[]}};f.LinearLayer=b;f.SoftmaxLayer=e;f.ReLuLayer=d;f.SigmoidLayer=g;f.fw_fn=c;f.bw_fn=h})(mlitb);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.sx=d.sx;this.in_depth=d.in_depth;this.in_sx=d.in_sx;this.in_sy=d.in_sy;this.sy=typeof d.sy!=="undefined"?d.sy:this.sx;this.stride=(typeof d.stride!=="undefined"&&d.stride<=this.sx)?d.stride:this.sx;this.ignore_border=typeof d.ignore_border!=="undefined"?d.ignore_border:false;this.pool_type=typeof d.pool_type!=="undefined"?d.pool_type:"max";this.out_depth=this.in_depth;this.out_sx=Math.floor(this.in_sx/this.stride);this.out_sy=Math.floor(this.in_sy/this.stride);this.max_pos_x=c.zeros(this.out_sx*this.out_sy*this.out_depth);this.max_pos_y=c.zeros(this.out_sx*this.out_sy*this.out_depth);this.layer_type="pool"};b.prototype={forward:function(h,k){this.V_in=h;var e=new a(this.out_sx,this.out_sy,this.out_depth,0);var s=this.max_pos_x;var r=this.max_pos_y;var m=e.data;var w=Math.floor(this.sx/2);var t=Math.floor(this.sy/2);var q=0;for(var x=0;x<this.out_depth;x++){for(var o=0,i=0;i<this.out_sy;o+=this.stride,i++){for(var p=0,j=0;j<this.out_sx;p+=this.stride,j++,q++){var z=-99999999;var y=-1;var u=-1;for(var f=o;f<this.sy+o;f++){for(var g=p;g<this.sx+p;g++){var l=-999999999;if(g<this.in_sx&&f<this.in_sy){l=h.data[((h.sx*f)+g)+h.sx*h.sy*x]}if(l>z){z=l;y=g;u=f}}}e.data[q]=z;s[q]=y;r[q]=u}}}this.V_out=e;return this.V_out},backward:function(){var o=this.V_in;o.drv=c.zeros(o.data.length);var l=o.drv;var h=this.V_out.drv;var m=this.max_pos_x;var k=this.max_pos_y;var e=0;for(var i=0;i<this.out_depth;i++){for(var f=0;f<this.out_sy;f++){for(var g=0;g<this.out_sx;g++,e++){var j=o.getIndex(m[e],k[e],i);l[j]+=h[e]}}}},getParamsAndGrads:function(){return[]}},c.PoolLayer=b})(mlitb);(function(c){var a=c.Vol;var b=function(d){this.out_sx=d.in_sx;this.out_sy=d.in_sy;this.out_depth=d.in_depth;this.drop_prob=typeof d.drop_prob==="number"?d.drop_prob:0.5;this.layer_type="dropout";this.drop_index=[]};b.prototype={forward:function(d,g){this.drop_index=[];this.V_in=d;var f=d.clone();if(g){for(var e=0;e<f.data.length;e++){if(Math.random()<this.drop_prob){f.data[e]=0;this.drop_index.push(e)}}}this.V_out=f;return this.V_out},backward:function(){var e=this.V_out.data;var f=this.V_in.drv;f=c.zeros(f.length);var g=this.V_in.data.length;for(var d=0;d<this.drop_index.length;d++){idx=this.drop_index[d];f[idx]=this.V_out.drv[idx]}},getParamsAndGrads:function(){return[]}};c.DropoutLayer=b})(mlitb);(function(b){var a=function(){this.layers=[];this.layer_conf=[]};a.prototype={createLayers:function(d){if(d[0].type!=="input"){console.log("ERROR : First layer should be an input type layer")}var f=[];for(var e=0;e<d.length;e++){var h=d[e];f.push(h);if(h.type==="conv"){if(typeof h.activation!=="undefined"){f.push({type:h.activation})}else{f.push({type:"relu"})}}else{if(h.type==="fc"){if(typeof h.num_neurons==="undefined"){console.log("ERROR : number of neuron parameter 'num_neurons' is not defined")}if(typeof h.activation!=="undefined"){f.push({type:h.activation})}else{f.push({type:"linear"})}}else{if(h.type==="pool"){if(typeof h.sx==="undefined"){console.log("ERROR : pool size parameter 'sx' is not defined")}if(typeof h.stride==="number"){var g=typeof h.sy==="number"?Math.min(h.sx,h.sy):h.sx;if(h.stride>g){console.log("BAD PARAMETER : stride should <= pooling size")}}else{console.log("WARNING : 'stride' parameter is not defined. Using default = 1")}if(typeof drop_prob!=="undefined"){f.push({type:"dropout",drop_prob:drop_prob})}}}}}this.layer_conf=f;this.constructNetwork()},constructNetwork:function(){var f=this.layer_conf;this.layers.push(new b.InputLayer(f[0]));for(var d=1;d<f.length;d++){var e=this.layers[d-1];var c=f[d];c.in_sx=e.out_sx;c.in_sy=e.out_sy;c.in_depth=e.out_depth;c.in_neurons=e.out_sx*e.out_sy*e.out_depth;if(c.type==="fc"){this.layers.push(new b.FullConnLayer(c))}else{if(c.type==="conv"){this.layers.push(new b.ConvLayer(c))}else{if(c.type==="sigmoid"){this.layers.push(new b.SigmoidLayer(c))}else{if(c.type==="softmax"){this.layers.push(new b.SoftmaxLayer(c))}else{if(c.type==="linear"){this.layers.push(new b.LinearLayer(c))}else{if(c.type==="relu"){this.layers.push(new b.ReLuLayer(c))}else{if(c.type==="pool"){this.layers.push(new b.PoolLayer(c))}else{if(c.type==="dropout"){this.layers.push(new b.DropOutLayer(c))}}}}}}}}}},forward:function(g,f){var d=g;for(var e=0;e<this.layers.length;e++){var c=this.layers[e].forward(d,f);d=c}},backward:function(e){var d=this.layers[this.layers.length-1].backward(e);for(var c=this.layers.length-2;c>=0;c--){this.layers[c].backward()}return d},saveNetwork:function(){var c={};c.layer_conf=this.layer_conf;return c},loadNetwork:function(c){this.layer_conf=c.layer_conf;this.constructNetwork()},getPrediction:function(){return this.layers[this.layers.length-1].V_out},getParamsAndGrads:function(){var d=[];for(var e=0;e<this.layers.length;e++){var f=this.layers[e].getParamsAndGrads();for(var c=0;c<f.length;c++){d.push(f[c])}}return d}};b.Net=a})(mlitb);(function(b){var a=function(d,c){this.net=d;this.learning_rate=typeof c.learning_rate!=="undefined"?c.learning_rate:0.01;this.k=0;this.last_gs=[]};a.prototype={train:function(c,e){this.net.forward(c);this.net.backward(e);for(var d=0;d<this.net.der.length;d++){b.W[d]=mlitb.add(b.W[d],mlitb.dot(this.net.der[d],this.learning_rate))}},checkGrad:function(d,k){this.net.forward(d);var g=[];var c=[];for(var h=0;h<b.W.length;h++){g[h]=b.clone(b.W[h])}console.log("current W");console.log(g);this.net.backward(k);var f=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(f);for(var h=0;h<b.W.length;h++){c[h]=b.clone(this.net.der[h])}console.log("derivative");console.log(c);console.log("adding epsilon to current W");var j=0.0001;b.W[0][0][0]=b.W[0][0][0]+j;this.net.forward(d);this.net.backward(k);var e=this.net.layers[this.net.layers.length-1].err;console.log("error");console.log(e);console.log("manual grad");console.log((e-f)/j)}};mlitb.SGD=a})(mlitb);(function(b){var a=function(d,c){this.net=d;this.loss=0;this.l2_loss=0;this.l1_loss=0;this.learning_rate=typeof c.learning_rate!=="undefined"?c.learning_rate:0.01;this.l1_decay=typeof c.l1_decay!=="undefined"?c.l1_decay:0;this.l2_decay=typeof c.l2_decay!=="undefined"?c.l2_decay:0;this.batch_size=typeof c.batch_size!=="undefined"?c.batch_size:1;this.momentum=typeof c.momentum!=="undefined"?c.momentum:0.9;this.iteration=0;this.last_grads=[]};a.prototype={train:function(l,h){var f=new Date().getTime();this.net.forward(l,true);var n=new Date().getTime()-f;var f=new Date().getTime();this.loss+=this.net.backward(h);var v=new Date().getTime()-f;this.iteration++;if(this.iteration%this.batch_size==0){console.log("sample seen : ",this.iteration);console.log("loss : ",this.loss/this.iteration);var t=this.net.getParamsAndGrads();if(this.last_grads.length==0&&this.momentum>0){for(var q=0;q<t.length;q++){this.last_grads.push(b.zeros(t[q].grads.length))}}for(var q=0;q<t.length;q++){var u=t[q];var e=u.params;var s=u.grads;var m=e.length;var w=this.last_grads[q];for(var o=0;o<m;o++){this.l2_loss+=this.l2_decay*e[o]*e[o];this.l1_loss+=this.l1_decay*Math.abs(e[o]);var r=this.l2_decay*e[o];var k=this.l1_decay*(e[o]>0?1:-1);var d=w[o];var c=(1-this.momentum)*this.learning_rate*((k+r+s[o])/this.batch_size)+this.momentum*d;e[o]-=c;d=c;s[o]=0}}}}};b.SGDTrainer=a})(mlitb);var conf=[];conf.push({type:"input",sx:28,sy:28,depth:1});conf.push({type:"conv",sx:5,stride:1,filters:8,activation:"relu",drop_conn_prob:0.5});conf.push({type:"pool",sx:2,stride:2});conf.push({type:"conv",sx:5,stride:1,filters:16,activation:"relu",drop_conn_prob:0.5});conf.push({type:"pool",sx:3,stride:3,drop_prob:0.5});conf.push({type:"fc",num_neurons:10,activation:"softmax"});var Net=new mlitb.Net();Net.createLayers(conf);var SGD=new mlitb.SGDTrainer(Net,{learning_rate:0.1,batch_size:16,l2_decay:0.001});var PNG=require("png-js");var train_labels=require("../../Data/Mnist/mnist_train_labels.json");var test_labels=require("../../Data/Mnist/mnist_test_labels.json");console.log(train_labels.length);console.log(test_labels.length);var loadedImages=[];var testImages=[];var parsePNG=function(c,d,e,a){var b=typeof a!=="undefined"?a:true;PNG.decode(c,function(p){var f=p.length/4/d;var o=d;for(var l=0;l<f;l++){var m=mlitb.zeros(784);for(var g=0,h=l*o*4;h<(l+1)*o*4;h+=4,g++){R=p[h]/255;m[g]=R}e.push(m)}})};parsePNG("../../Data/Mnist/mnist_train_all.png",784,loadedImages);parsePNG("../../Data/Mnist/mnist_test_all.png",784,testImages);var checkLoading=function(){if(loadedImages.length==60000){console.log("masuk");sampleAndTrainBatches()}else{console.log(loadedImages.length);setTimeout(checkLoading,100)}};checkLoading();var sampleAndTrainBatches=function(){var d=Math.floor(Math.random()*20);var r=d*3000;var a=100;var g=100;var l=100;var p=0;var h=1;for(var s=0;s<a;s++){console.log("Epoch "+s);for(var q=r;q<r+3000;q++,h++){var m=new mlitb.Vol(28,28,1,0);var n=loadedImages[q];var c=train_labels[q];m.data=n;SGD.train(m,c);var k=Net.getPrediction().data;var o=0;for(var e=1;e<k.length;e++){if(k[e]>k[o]){o=e}}if(c===o){p+=1}if(h%16==0){correctTest=0;for(var f=0;f<g;f++){var b=Math.floor(Math.random()*testImages.length);var m=new mlitb.Vol(28,28,1,0);var n=testImages[b];var c=test_labels[b];m.data=n;Net.forward(m);var k=Net.getPrediction().data;var o=0;for(var e=1;e<k.length;e++){if(k[e]>k[o]){o=e}}if(c===o){correctTest+=1}}console.log("Train accuracy : ",p/SGD.iteration);console.log("Test accuracy : ",correctTest/g)}}}};var loadBatches=function(c){for(var b=0;b<c;b++){loadedImages=[];parsePNG("../../Data/Mnist/mnist_batch_"+b+".png",784);var a=setInterval(function(){console.log(loadedImages.length);if(loadedImages[0]&&loadedImages[2999]){clearInterval(a);console.log("lengkap")}},100);console.log("teseteswets")}};